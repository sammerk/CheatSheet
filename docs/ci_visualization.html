<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfidenzintervall-Visualisierung</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <style>
        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 10px;
        }
        
        #container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            #container {
                padding: 15px;
            }
        }
        
        h1 {
            color: #267326;
            text-align: center;
            font-size: 1.8rem;
            margin: 10px 0 20px 0;
        }
        
        #controls {
            margin: 20px 0;
            padding: 15px;
            background: #f2f2f2;
            border-radius: 5px;
        }
        
        .controls-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .controls-row.bottom-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        label {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .value-display {
            color: #267326;
            font-weight: 700;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #d77d00;
            outline: none;
            border-radius: 3px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #d77d00;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(215, 125, 0, 0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #d77d00;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 0 3px rgba(215, 125, 0, 0.3);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 0 0 5px rgba(215, 125, 0, 0.4);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            box-shadow: 0 0 0 5px rgba(215, 125, 0, 0.4);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.4rem;
            }
            
            .controls-row,
            .controls-row.bottom-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .button-group {
                flex-wrap: wrap;
            }
        }
        
        button {
            background-color: #267326;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            min-width: 80px;
        }
        
        @media (max-width: 480px) {
            button {
                width: calc(50% - 10px);
                margin: 5px;
            }
        }
        
        button:hover {
            background-color: #1e5a1e;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #viz {
            margin: 20px auto;
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .ci-line {
            stroke-width: 3;
            opacity: 0.7;
        }
        
        .ci-line.covers {
            stroke: #267326;
        }
        
        .ci-line.misses {
            stroke: #d77d00;
        }
        
        .mean-point {
            fill: #333;
            stroke: white;
            stroke-width: 1;
        }
        
        .true-mean-line {
            stroke: #666;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }
        
        #stats {
            margin: 20px 0;
            padding: 15px;
            background: #f2f2f2;
            border-radius: 5px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .stat-box {
            flex: 1;
            min-width: 120px;
            padding: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #267326;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .stat-box {
                min-width: 45%;
                flex: 0 1 45%;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .stat-box {
                min-width: 100%;
                flex: 0 1 100%;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Konfidenzintervall-Visualisierung</h1>
        
        <div id="controls">
            <div class="controls-row">
                <div class="control-group">
                    <label for="nTrials">
                        Anzahl Versuche (n): <span class="value-display" id="nTrialsValue">30</span>
                    </label>
                    <input type="range" id="nTrials" min="5" max="100" value="30" step="5">
                </div>
                
                <div class="control-group">
                    <label for="trueP">
                        Wahre Erfolgswahrscheinlichkeit (θ): <span class="value-display" id="truePValue">0.50</span>
                    </label>
                    <input type="range" id="trueP" min="0.1" max="0.9" value="0.5" step="0.05">
                </div>
            </div>
            
            <div class="controls-row bottom-row">
                <div class="control-group">
                    <label for="confLevel">
                        Konfidenzniveau: <span class="value-display" id="confLevelValue">95%</span>
                    </label>
                    <input type="range" id="confLevel" min="80" max="99" value="95" step="1">
                </div>
                
                <div class="button-group">
                    <button id="startBtn">Start</button>
                    <button id="pauseBtn" disabled>Pause</button>
                    <button id="resetBtn">Reset</button>
                </div>
            </div>
        </div>
        
        <svg id="viz" width="900" height="250"></svg>
        
        <div id="stats">
            <div class="stat-box">
                <div class="stat-value" id="totalSamples">0</div>
                <div class="stat-label">Gezogene Stichproben</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="covering">0</div>
                <div class="stat-label">KIs enthalten θ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="missing">0</div>
                <div class="stat-label">KIs verfehlen θ</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="coverage">0%</div>
                <div class="stat-label">Abdeckungsrate</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const container = document.getElementById("container");
        const svg = d3.select("#viz");
        const margin = {top: 40, right: 40, bottom: 60, left: 60};
        
        // Make responsive
        let width = Math.min(900, container.clientWidth - 60);
        let height = 250;
        let plotWidth = width - margin.left - margin.right;
        let plotHeight = height - margin.top - margin.bottom;
        
        // Set initial SVG size
        svg.attr("width", width).attr("height", height);
        
        // State
        let samples = [];
        let allSamples = [];
        let isRunning = false;
        let intervalId = null;
        let maxVisibleSamples = 30;
        
        // Scales
        const xScale = d3.scaleLinear()
            .domain([0, 1])
            .range([0, plotWidth]);
            
        const yScale = d3.scaleLinear()
            .domain([0, maxVisibleSamples])
            .range([plotHeight, 0]);
        
        // Create plot group
        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Add axes
        const xAxis = d3.axisBottom(xScale);
        const yAxis = d3.axisLeft(yScale);
        
        g.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${plotHeight})`)
            .call(xAxis);
        
        g.append("g")
            .attr("class", "y-axis")
            .call(yAxis);
        
        // Add true p line (will be updated dynamically)
        const truePLine = g.append("line")
            .attr("class", "true-mean-line")
            .attr("y1", 0)
            .attr("y2", plotHeight);
        
        // Add axis labels
        const xLabelGroup = g.append("g")
            .attr("transform", `translate(${plotWidth / 2}, ${plotHeight + 35})`);
        
        xLabelGroup.append("foreignObject")
            .attr("width", 300)
            .attr("height", 30)
            .attr("x", -150)
            .attr("y", -10)
            .html('<div style="text-align: center; font-size: 14px;">Geschätzter Anteil (\\(\\hat{\\theta}\\))</div>');
        
        g.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", -45)
            .attr("x", -plotHeight / 2)
            .style("text-anchor", "middle")
            .text("Stichprobe");
        
        // Function to update true p line
        function updateTruePLine() {
            const trueP = parseFloat(document.getElementById("trueP").value);
            truePLine
                .attr("x1", xScale(trueP))
                .attr("x2", xScale(trueP));
        }
        
        updateTruePLine();
        
        // Generate sample and calculate CI using Clopper-Pearson interval
        function generateSample() {
            const n = parseInt(document.getElementById("nTrials").value);
            const trueP = parseFloat(document.getElementById("trueP").value);
            const confLevel = parseInt(document.getElementById("confLevel").value) / 100;
            
            // Generate binomial sample (number of successes)
            let successes = 0;
            for (let i = 0; i < n; i++) {
                if (Math.random() < trueP) {
                    successes++;
                }
            }
            
            const pHat = successes / n;
            const x = successes;
            
            // Clopper-Pearson interval using jStat beta distribution
            const alpha = 1 - confLevel;
            
            let ciLower, ciUpper;
            
            if (x === 0) {
                ciLower = 0;
                ciUpper = 1 - Math.pow(alpha / 2, 1 / n);
            } else if (x === n) {
                ciLower = Math.pow(alpha / 2, 1 / n);
                ciUpper = 1;
            } else {
                // Use beta distribution quantiles
                ciLower = jStat.beta.inv(alpha / 2, x, n - x + 1);
                ciUpper = jStat.beta.inv(1 - alpha / 2, x + 1, n - x);
            }
            
            const covers = (ciLower <= trueP) && (trueP <= ciUpper);
            
            return {
                id: allSamples.length,
                pHat: pHat,
                ciLower: ciLower,
                ciUpper: ciUpper,
                covers: covers
            };
        }
        
        // Quantile function for standard normal distribution (approximation)
        function quantileNormal(p) {
            // Beasley-Springer-Moro algorithm
            const a = [2.50662823884, -18.61500062529, 41.39119773534, -25.44106049637];
            const b = [-8.47351093090, 23.08336743743, -21.06224101826, 3.13082909833];
            const c = [0.3374754822726147, 0.9761690190917186, 0.1607979714918209, 
                      0.0276438810333863, 0.0038405729373609, 0.0003951896511919,
                      0.0000321767881768, 0.0000002888167364, 0.0000003960315187];
            
            if (p <= 0 || p >= 1) return NaN;
            
            const y = p - 0.5;
            
            if (Math.abs(y) < 0.42) {
                const r = y * y;
                let x = y * (((a[3] * r + a[2]) * r + a[1]) * r + a[0]);
                x /= ((((b[3] * r + b[2]) * r + b[1]) * r + b[0]) * r + 1);
                return x;
            }
            
            const r = p < 0.5 ? p : 1 - p;
            const s = Math.sqrt(-Math.log(r));
            let x;
            
            if (s < 3) {
                const t = s - 1.6;
                x = c[0] + t * (c[1] + t * (c[2] + t * (c[3] + t * (c[4] + t * (c[5] + t * (c[6] + t * (c[7] + t * c[8])))))));
            } else {
                const t = s - 3;
                x = c[0] + t * (c[1] + t * (c[2] + t * (c[3] + t * (c[4] + t * (c[5] + t * (c[6] + t * (c[7] + t * c[8])))))));
            }
            
            return p < 0.5 ? -x : x;
        }
        
        // Update visualization
        function updateViz() {
            // Assign display indices to visible samples
            samples.forEach((d, i) => {
                d.displayIndex = i;
            });
            
            // Bind data
            const lines = g.selectAll(".ci-line")
                .data(samples, d => d.id);
            
            const points = g.selectAll(".mean-point")
                .data(samples, d => d.id);
            
            // Exit old elements - remove immediately without transition
            lines.exit().remove();
            points.exit().remove();
            
            // Enter new lines
            lines.enter()
                .append("line")
                .attr("class", d => "ci-line " + (d.covers ? "covers" : "misses"))
                .attr("x1", d => xScale(d.ciLower))
                .attr("x2", d => xScale(d.ciUpper))
                .attr("y1", d => yScale(d.displayIndex))
                .attr("y2", d => yScale(d.displayIndex));
            
            // Update existing lines
            lines
                .attr("y1", d => yScale(d.displayIndex))
                .attr("y2", d => yScale(d.displayIndex));
            
            // Enter new points
            points.enter()
                .append("circle")
                .attr("class", "mean-point")
                .attr("cx", d => xScale(d.pHat))
                .attr("cy", d => yScale(d.displayIndex))
                .attr("r", 3);
            
            // Update existing points
            points
                .attr("cy", d => yScale(d.displayIndex));
            
            // Update statistics
            updateStats();
        }
        
        // Update statistics
        function updateStats() {
            const total = allSamples.length;
            const covering = allSamples.filter(d => d.covers).length;
            const missing = total - covering;
            const coverage = total > 0 ? ((covering / total) * 100).toFixed(1) : 0;
            
            document.getElementById("totalSamples").textContent = total;
            document.getElementById("covering").textContent = covering;
            document.getElementById("missing").textContent = missing;
            document.getElementById("coverage").textContent = coverage + "%";
        }
        
        // Add one sample
        function addSample() {
            const sample = generateSample();
            allSamples.push(sample);
            
            // Add to visible samples at the beginning
            samples.unshift(sample);
            
            // Keep only the most recent maxVisibleSamples
            if (samples.length > maxVisibleSamples) {
                samples = samples.slice(0, maxVisibleSamples);
            }
            
            updateViz();
        }
        
        // Start animation
        function start() {
            isRunning = true;
            document.getElementById("startBtn").disabled = true;
            document.getElementById("pauseBtn").disabled = false;
            
            intervalId = setInterval(addSample, 150);
        }
        
        // Pause animation
        function pause() {
            isRunning = false;
            document.getElementById("startBtn").disabled = false;
            document.getElementById("pauseBtn").disabled = true;
            
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }
        
        // Reset
        function reset() {
            pause();
            samples = [];
            allSamples = [];
            
            g.selectAll(".ci-line").remove();
            g.selectAll(".mean-point").remove();
            
            updateStats();
            document.getElementById("startBtn").disabled = false;
        }
        
        // Event listeners
        document.getElementById("startBtn").addEventListener("click", start);
        document.getElementById("pauseBtn").addEventListener("click", pause);
        document.getElementById("resetBtn").addEventListener("click", reset);
        
        // Update displayed values
        document.getElementById("nTrials").addEventListener("input", function() {
            document.getElementById("nTrialsValue").textContent = this.value;
        });
        
        document.getElementById("trueP").addEventListener("input", function() {
            document.getElementById("truePValue").textContent = parseFloat(this.value).toFixed(2);
            updateTruePLine();
        });
        
        document.getElementById("confLevel").addEventListener("input", function() {
            document.getElementById("confLevelValue").textContent = this.value + "%";
        });
        
        // Handle window resize
        window.addEventListener("resize", function() {
            const newWidth = Math.min(900, container.clientWidth - 60);
            if (Math.abs(newWidth - width) > 50) {
                width = newWidth;
                plotWidth = width - margin.left - margin.right;
                
                svg.attr("width", width);
                xScale.range([0, plotWidth]);
                
                // Update axes
                g.select(".x-axis").call(d3.axisBottom(xScale));
                
                // Update true p line
                updateTruePLine();
                
                // Update all CI lines and points
                g.selectAll(".ci-line")
                    .attr("x1", d => xScale(d.ciLower))
                    .attr("x2", d => xScale(d.ciUpper));
                
                g.selectAll(".mean-point")
                    .attr("cx", d => xScale(d.pHat));
            }
        });
    </script>
</body>
</html>
